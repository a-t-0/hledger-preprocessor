# Hledger .csv bank statement preprocessor for hledger-flow

[![Python 3.12][python_badge]](https://www.python.org/downloads/release/python-3120/)
[![License: AGPL v3][agpl3_badge]](https://www.gnu.org/licenses/agpl-3.0)
[![Code Style: Black][black_badge]](https://github.com/ambv/black)

Pre-processes bank `.csv` files so that hledger-flow can convert them into
`hledger` journals.

Aims to support ((separate) pure logic based & AI-based) auto-transaction
classification.

## Usage

First install this pip package with:

```bash
pip install hledger_preprocessor
```

Then run:

```sh
clear && hledger_preprocessor --start-path ~/hledger-flow-example \
--generate-rules \
--account-holder your_name \
--bank triodos \
--account-type checking

clear && hledger_preprocessor --input-file some.csv \
--start-path ~/hledger-flow-example \
--account-holder your_name \
--bank triodos \
--account-type checking_or_saving_or_something \
--pre-processed-output-dir=2-preprocessed
```

## Tests

```sh
python -m pytest
```

## Developer

```bash
conda env create --file environment.yml
conda activate hledger_preprocessor

pre-commit install
pre-commit autoupdate
pre-commit run --all
```

## Publish pip package

Install the pip package locally with:

```bash
rm -r build
python -m build
pip install -e .
```

Upload the pip package to the world with:

```bash
rm -r build
python -m build
python3 -m twine upload dist/\*
```

## Sphinx documentation

To generate the documentation ensure the pip package is installed locally, such
that the documentation is able to import its Python files.

```bash
rm -r build
python -m build
pip install -e .
```

Then build the documentation with::

```sh
cd docs
pip install -r requirements.txt
make html
```

You can now see all your auto-generated Sphinx documentation in:
[docs/build/html/index.html](docs/build/html/index.html). This repository
auto-generates the Sphinx documentation for all your Python files using the
[/docs/source/conf.py](/docs/source/conf.py) file.

### Additional manual documentation

- The [docs/source/index.rst](docs/source/index.rst) is autogenerated and
  contains the main page and documentation file-structure.
- You can also add additional manual documentation in Markdown format as files in:

```
docs/source/manual_documenation/your_manual_documentation_filename.md
docs/source/manual_documenation/another_manual_documentation_filename.md
```

and then adding those filepaths into the `docs/source/manual.rst` file like:

```rst
Handwritten Documentation
=========================
.. toctree::
   :maxdepth: 2

   manual_documenation/your_manual_documentation_filename.md
   another_manual_documentation_filename.md
```

## Ubuntu hledger-flow installation instructions

Source: https://github.com/apauley/hledger-flow/blob/master/CONTRIBUTING.org#build-the-project
This pip package is intended to be used by
[this fork](https://github.com/a-t-0/hledger-flow/) of the hledger-flow repository.

0. Install [stack](https://docs.haskellstack.org/en/stable/):

```sh
curl -sSL https://get.haskellstack.org/ | sh
```

1. Install prerequiesite package:

```sh
sudo apt-get install libgmp-dev
```

2. Build the repo with:

```sh
stack test --interleaved-output --pedantic
stack install
```

4. Add to path

```sh
echo 'export PATH=$PATH:/home/a/.local/bin' >> ~/.bashrc
source ~/.bashrc
```

5. Create a starting directory with some `.csv` file you downloaded from your bank.

```sh
mkdir -p import/<account holder>/<bank>/<account type>/1-in/2024
```

This structure is hardcoded/required by `hledger-flow`
e.g.

```sh
mkdir -p import/barry/revolut/checking/1-in/2025
```

6. Copy your `<bank transactions>.csv` into that directory like:

```sh
cp blockrise.csv import/alice/uniswap/crypto/1-in/filename_doesnt_matter.csv
```

7. Copy the `createRules` and `preprocess` script into the `<account type>` directory, and make them runnable:

```sh
cp createRules import/barry/revolut/checking/createRules
chmod +x createRules
cp preprocess import/barry/revolut/checking/preprocess
chmod +x preprocess
```

8. Copy the `CONSTANTS.SH` file into the root of your finance repository:

```sh
cp CONSTANTS.sh /path_that_contains_the_import_dir/CONSTANTS.sh
```

9. Run the `hledger-flow import` command.

<!-- Un-wrapped URL's below (Mostly for Badges) -->

[agpl3_badge]: https://img.shields.io/badge/License-AGPL_v3-blue.svg
[black_badge]: https://img.shields.io/badge/code%20style-black-000000.svg
[python_badge]: https://img.shields.io/badge/python-3.6-blue.svg
